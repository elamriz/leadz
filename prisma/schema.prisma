generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────────────
enum LeadStatus {
  NEW
  READY
  QUEUED
  SENT
  BOUNCED
  REPLIED
  NOT_INTERESTED
  FOLLOW_UP
  DO_NOT_CONTACT
}

enum EmailConfidence {
  HIGH
  MEDIUM
  LOW
  GUESSED
  NONE
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum SendStatus {
  QUEUED
  SENT
  FAILED
  BOUNCED
  OPENED
  CLICKED
  REPLIED
  UNSUBSCRIBED
}

// ─── Lead ───────────────────────────────────────────────────────
model Lead {
  id                String       @id @default(uuid())
  placeId           String?      @unique
  displayName       String
  formattedAddress  String?
  city              String?
  region            String?
  country           String?
  nationalPhone     String?
  websiteUri        String?
  websiteDomain     String?
  rating            Float?
  userRatingCount   Int?
  businessStatus    String?
  types             String[]     @default([])
  latitude          Float?
  longitude         Float?
  niche             String?
  status            LeadStatus   @default(NEW)
  score             Int          @default(0)
  topReasons        String[]     @default([])
  tags              String[]     @default([])
  notes             String?
  lastContactedAt   DateTime?
  contactCooldownDays Int        @default(30)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  emails            LeadEmail[]
  scoringSignals    ScoringSignal?
  campaignSends     CampaignSend[]
  searchRunLeads    SearchRunLead[]
  auditLogs         AuditLog[]

  @@index([status])
  @@index([score])
  @@index([niche])
  @@index([websiteDomain])
  @@index([nationalPhone])
}

model LeadEmail {
  id          String          @id @default(uuid())
  leadId      String
  email       String
  source      String          @default("website_crawl")
  confidence  EmailConfidence @default(NONE)
  isGeneric   Boolean         @default(false)
  createdAt   DateTime        @default(now())

  lead        Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([leadId, email])
  @@index([email])
}

// ─── Scoring ────────────────────────────────────────────────────
model ScoringSignal {
  id               String   @id @default(uuid())
  leadId           String   @unique
  hasWebsite       Boolean  @default(false)
  httpsPresent     Boolean  @default(false)
  mobileFriendly   Boolean  @default(false)
  loadTimeMs       Int?
  hasMetaTags      Boolean  @default(false)
  hasTitle         Boolean  @default(false)
  hasDescription   Boolean  @default(false)
  outdatedTech     Boolean  @default(false)
  emailFound       Boolean  @default(false)
  phoneFound       Boolean  @default(false)
  ratingValue      Float?
  reviewCount      Int?
  isOperational    Boolean  @default(true)
  distanceFromCenter Float?
  calculatedAt     DateTime @default(now())

  lead             Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model ScoringConfig {
  id                    String  @id @default(uuid())
  name                  String  @default("default")
  noWebsiteWeight       Int     @default(30)
  highRatingWeight      Int     @default(10)
  highRatingThreshold   Float   @default(4.3)
  reviewCountWeight     Int     @default(15)
  reviewCountThreshold  Int     @default(50)
  highReviewCountWeight Int     @default(25)
  highReviewCountThreshold Int  @default(200)
  hasPhoneWeight        Int     @default(5)
  emailFoundWeight      Int     @default(10)
  noHttpsWeight         Int     @default(10)
  notMobileFriendlyWeight Int   @default(10)
  slowLoadWeight        Int     @default(5)
  slowLoadThreshold     Int     @default(3000)
  noMetaTagsWeight      Int     @default(5)
  recentContactPenalty  Int     @default(10)
  isActive              Boolean @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ─── Search Runs ────────────────────────────────────────────────
model SearchRun {
  id                String    @id @default(uuid())
  query             String
  location          String
  latitude          Float?
  longitude         Float?
  radiusKm          Int       @default(50)
  maxResults        Int       @default(60)
  maxSearchRequests Int       @default(5)
  maxDetailRequests Int       @default(60)
  maxPaginationDepth Int      @default(3)
  isDryRun          Boolean   @default(false)
  status            String    @default("pending")
  totalPlacesFound  Int       @default(0)
  totalNewLeads     Int       @default(0)
  totalDuplicates   Int       @default(0)
  searchRequests    Int       @default(0)
  detailRequests    Int       @default(0)
  estimatedCost     Float     @default(0)
  errors            String[]  @default([])
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  leads             SearchRunLead[]
}

model SearchRunLead {
  id          String    @id @default(uuid())
  searchRunId String
  leadId      String
  isDuplicate Boolean   @default(false)
  createdAt   DateTime  @default(now())

  searchRun   SearchRun @relation(fields: [searchRunId], references: [id], onDelete: Cascade)
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([searchRunId, leadId])
}

// ─── Campaigns ──────────────────────────────────────────────────
model Campaign {
  id               String          @id @default(uuid())
  name             String
  subject          String
  templateId       String?
  niche            String?
  channel          String          @default("email")
  noWebsiteOnly    Boolean         @default(false)
  status           CampaignStatus  @default(DRAFT)
  dailyLimit       Int             @default(50)
  minDelaySeconds  Int             @default(5)
  maxDelaySeconds  Int             @default(45)
  cooldownDays     Int             @default(30)
  safeSendMode     Boolean         @default(true)
  audienceFilters  String?
  totalSent        Int             @default(0)
  totalFailed      Int             @default(0)
  totalBounced     Int             @default(0)
  totalOpened      Int             @default(0)
  totalReplied     Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  template         EmailTemplate?  @relation(fields: [templateId], references: [id])
  sends            CampaignSend[]
}

model CampaignSend {
  id           String      @id @default(uuid())
  campaignId   String
  leadId       String
  email        String
  status       SendStatus  @default(QUEUED)
  templateUsed String?
  errorMessage String?
  sentAt       DateTime?
  bouncedAt    DateTime?
  openedAt     DateTime?
  repliedAt    DateTime?
  createdAt    DateTime    @default(now())

  campaign     Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead         Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([leadId])
  @@index([status])
}

model EmailTemplate {
  id          String     @id @default(uuid())
  name        String
  subject     String
  body        String
  type        String     @default("email")
  niche       String?
  variables   String[]   @default([])
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  campaigns   Campaign[]
}

// ─── Suppression ────────────────────────────────────────────────
model SuppressionEntry {
  id        String   @id @default(uuid())
  email     String?  @unique
  domain    String?  @unique
  reason    String   @default("manual")
  createdAt DateTime @default(now())
}

// ─── API Usage ──────────────────────────────────────────────────
model ApiUsage {
  id           String   @id @default(uuid())
  date         DateTime @db.Date
  endpoint     String
  requestCount Int      @default(0)
  estimatedCost Float   @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([date, endpoint])
}

model ApiUsageCap {
  id                    String  @id @default(uuid())
  dailySearchLimit      Int     @default(100)
  dailyDetailLimit      Int     @default(500)
  monthlySearchLimit    Int     @default(2000)
  monthlyDetailLimit    Int     @default(10000)
  perRunSearchLimit     Int     @default(10)
  perRunDetailLimit     Int     @default(100)
  perRunMaxPlaces       Int     @default(100)
  maxPaginationDepth    Int     @default(3)
  searchCostPer1000     Float   @default(32.0)
  detailCostPer1000     Float   @default(17.0)
  dailySendLimit        Int     @default(100)
  monthlySendLimit      Int     @default(2000)
  warningThreshold80    Boolean @default(true)
  warningThreshold95    Boolean @default(true)
  isActive              Boolean @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ─── Audit Log ──────────────────────────────────────────────────
model AuditLog {
  id        String   @id @default(uuid())
  leadId    String?
  action    String
  details   String?
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  lead      Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([leadId])
  @@index([createdAt])
}

// ─── Settings ───────────────────────────────────────────────────
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
